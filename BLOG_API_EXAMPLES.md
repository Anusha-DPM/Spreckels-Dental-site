# Blog API Examples

Complete guide for working with blog posts in the Spreckels Dental site.

## Table of Contents

- [Data Schema](#data-schema)
- [Create Blog Post](#create-blog-post)
- [Read Blog Posts](#read-blog-posts)
- [Update Blog Post](#update-blog-post)
- [Delete Blog Post](#delete-blog-post)
- [Image Upload](#image-upload)

## Data Schema

Blog posts are stored in Firebase Firestore with the following schema:

```typescript
interface BlogPost {
  // Core Fields
  id?: string                    // Auto-generated by Firestore
  title: string                  // Blog post title
  content: string                // HTML content
  excerpt?: string               // Brief summary
  slug: string                   // URL-friendly slug (auto-generated)
  
  // Image Fields (Cloudinary URLs)
  coverImage?: string            // Main image URL from Cloudinary
  imageUrl?: string              // Alternative image URL
  
  // Taxonomy
  tags: string[]                 // Array of tags
  categories: string[]           // Array of categories
  
  // SEO Metadata
  metaTitle: string              // SEO title
  metaDescription: string        // SEO description
  keyword?: string               // Primary keyword
  canonicalUrl?: string          // Canonical URL
  
  // Schema Markup (Optional)
  jsonLdSchema?: string          // JSON-LD schema script
  breadcrumbActive?: string      // Breadcrumb schema script
  faqSchema?: string             // FAQ schema script
  medicalConditionSchema?: string // Medical condition schema script
  
  // Publishing
  published: boolean             // Published status
  publishDate: string            // ISO date string
  createdAt: string              // ISO date string
  updatedAt: string              // ISO date string
  author?: string                // Author name
}
```

---

## Create Blog Post

### Example 1: Create Blog Post with Image Upload

```javascript
import { createBlogPost, generateSlug } from '../lib/blogDatabase'
import { uploadImageToCloudinary } from '../lib/cloudinary'

async function createPostWithImage() {
  try {
    // Step 1: Upload image to Cloudinary
    const imageFile = document.getElementById('imageInput').files[0]
    
    const uploadResult = await uploadImageToCloudinary(
      imageFile, 
      'blog-images',
      (progress) => {
        console.log(`Upload progress: ${progress.toFixed(1)}%`)
      }
    )
    
    console.log('Image uploaded:', uploadResult.url)
    
    // Step 2: Create blog post with Cloudinary URL
    const postData = {
      title: 'Understanding Dental Implants',
      content: '<p>Dental implants are a popular solution for missing teeth...</p>',
      excerpt: 'Learn everything about dental implants in this comprehensive guide.',
      coverImage: uploadResult.url,  // Cloudinary URL
      imageUrl: uploadResult.url,     // Cloudinary URL
      tags: ['dental implants', 'restorative dentistry', 'oral health'],
      categories: ['Dental Procedures', 'Patient Education'],
      metaTitle: 'Understanding Dental Implants | Complete Guide',
      metaDescription: 'A comprehensive guide to dental implants, including benefits, procedure, and aftercare.',
      keyword: 'dental implants',
      published: true,
      publishDate: new Date().toISOString()
    }
    
    const postId = await createBlogPost(postData)
    console.log('Blog post created with ID:', postId)
    
    return postId
  } catch (error) {
    console.error('Error creating blog post:', error)
    throw error
  }
}
```

### Example 2: Create Draft Blog Post (No Image)

```javascript
import { createBlogPost } from '../lib/blogDatabase'

async function createDraftPost() {
  const postData = {
    title: 'Tips for Maintaining Healthy Gums',
    content: '<p>Healthy gums are essential for overall oral health...</p>',
    excerpt: 'Learn practical tips for maintaining healthy gums.',
    tags: ['gum health', 'oral hygiene', 'prevention'],
    categories: ['Oral Health', 'Prevention'],
    metaTitle: 'Tips for Maintaining Healthy Gums',
    metaDescription: 'Essential tips and best practices for healthy gums.',
    published: false,  // Save as draft
    publishDate: new Date().toISOString()
  }
  
  const postId = await createBlogPost(postData)
  console.log('Draft saved with ID:', postId)
  
  return postId
}
```

### Example 3: Create Blog Post with Schema Markup

```javascript
import { createBlogPost } from '../lib/blogDatabase'

async function createPostWithSchema() {
  const postData = {
    title: 'What is Periodontitis?',
    content: '<p>Periodontitis is a serious gum infection...</p>',
    excerpt: 'Understanding periodontitis and its treatment options.',
    tags: ['periodontitis', 'gum disease', 'dental health'],
    categories: ['Oral Health', 'Conditions'],
    metaTitle: 'What is Periodontitis? Symptoms and Treatment',
    metaDescription: 'Learn about periodontitis symptoms, causes, and treatment options.',
    
    // Add FAQ Schema
    faqSchema: `<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [{
    "@type": "Question",
    "name": "What is periodontitis?",
    "acceptedAnswer": {
      "@type": "Answer",
      "text": "Periodontitis is a serious gum infection that damages soft tissue and destroys the bone that supports your teeth."
    }
  }]
}
</script>`,
    
    // Add Medical Condition Schema
    medicalConditionSchema: `<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "MedicalCondition",
  "name": "Periodontitis",
  "description": "A serious gum infection that damages soft tissue and bone."
}
</script>`,
    
    published: true,
    publishDate: new Date().toISOString()
  }
  
  const postId = await createBlogPost(postData)
  console.log('Blog post with schema created:', postId)
  
  return postId
}
```

---

## Read Blog Posts

### Example 1: Get All Published Posts (Public)

```javascript
import { getPublishedBlogPosts } from '../lib/blogDatabase'

async function getPublicPosts() {
  try {
    const posts = await getPublishedBlogPosts()
    
    console.log(`Found ${posts.length} published posts`)
    
    // Display posts
    posts.forEach(post => {
      console.log(`${post.title} - ${post.publishDate}`)
    })
    
    return posts
  } catch (error) {
    console.error('Error fetching posts:', error)
    return []
  }
}
```

### Example 2: Get All Posts (Admin)

```javascript
import { getBlogPosts } from '../lib/blogDatabase'

async function getAllPosts() {
  try {
    const posts = await getBlogPosts()
    
    // Separate published and drafts
    const published = posts.filter(p => p.published)
    const drafts = posts.filter(p => !p.published)
    
    console.log(`Published: ${published.length}, Drafts: ${drafts.length}`)
    
    return posts
  } catch (error) {
    console.error('Error fetching posts:', error)
    return []
  }
}
```

### Example 3: Get Single Post by ID

```javascript
import { getBlogPostById } from '../lib/blogDatabase'

async function getPostById(postId) {
  try {
    const post = await getBlogPostById(postId)
    
    if (!post) {
      console.log('Post not found')
      return null
    }
    
    console.log('Post retrieved:', post.title)
    console.log('Cover image:', post.coverImage)
    console.log('Published:', post.published)
    
    return post
  } catch (error) {
    console.error('Error fetching post:', error)
    return null
  }
}
```

### Example 4: Get Single Post by Slug

```javascript
import { getBlogPostBySlug } from '../lib/blogDatabase'

async function getPostBySlug(slug) {
  try {
    const post = await getBlogPostBySlug(slug)
    
    if (!post) {
      console.log('Post not found')
      return null
    }
    
    console.log('Post retrieved:', post.title)
    
    return post
  } catch (error) {
    console.error('Error fetching post:', error)
    return null
  }
}

// Usage
const post = await getPostBySlug('understanding-dental-implants')
```

### Example 5: Get Latest Posts

```javascript
import { getLatestBlogPosts } from '../lib/blogDatabase'

async function getLatestPosts() {
  try {
    // Get latest 3 posts
    const posts = await getLatestBlogPosts(3)
    
    console.log('Latest posts:')
    posts.forEach(post => {
      console.log(`- ${post.title}`)
    })
    
    return posts
  } catch (error) {
    console.error('Error fetching latest posts:', error)
    return []
  }
}
```

---

## Update Blog Post

### Example 1: Update Blog Post Content

```javascript
import { updateBlogPost } from '../lib/blogDatabase'

async function updatePostContent(postId) {
  try {
    await updateBlogPost(postId, {
      title: 'Updated: Understanding Dental Implants',
      content: '<p>Updated content with more information...</p>',
      excerpt: 'Updated excerpt with more details.',
      metaTitle: 'Updated: Understanding Dental Implants | Complete Guide',
      metaDescription: 'Updated comprehensive guide to dental implants.'
    })
    
    console.log('Post updated successfully')
  } catch (error) {
    console.error('Error updating post:', error)
    throw error
  }
}
```

### Example 2: Update Blog Post Image

```javascript
import { updateBlogPost } from '../lib/blogDatabase'
import { uploadImageToCloudinary } from '../lib/cloudinary'

async function updatePostImage(postId, newImageFile) {
  try {
    // Upload new image to Cloudinary
    const uploadResult = await uploadImageToCloudinary(
      newImageFile,
      'blog-images',
      (progress) => console.log(`Upload: ${progress}%`)
    )
    
    // Update post with new image URL
    await updateBlogPost(postId, {
      coverImage: uploadResult.url,
      imageUrl: uploadResult.url
    })
    
    console.log('Post image updated successfully')
  } catch (error) {
    console.error('Error updating image:', error)
    throw error
  }
}
```

### Example 3: Publish Draft Post

```javascript
import { updateBlogPost } from '../lib/blogDatabase'

async function publishDraft(postId) {
  try {
    await updateBlogPost(postId, {
      published: true,
      publishDate: new Date().toISOString()
    })
    
    console.log('Post published successfully')
  } catch (error) {
    console.error('Error publishing post:', error)
    throw error
  }
}
```

### Example 4: Update Tags and Categories

```javascript
import { updateBlogPost } from '../lib/blogDatabase'

async function updateTaxonomy(postId) {
  try {
    await updateBlogPost(postId, {
      tags: ['dental health', 'oral hygiene', 'prevention', 'wellness'],
      categories: ['General Dentistry', 'Preventive Care']
    })
    
    console.log('Tags and categories updated')
  } catch (error) {
    console.error('Error updating taxonomy:', error)
    throw error
  }
}
```

---

## Delete Blog Post

### Example: Delete Blog Post

```javascript
import { deleteBlogPost } from '../lib/blogDatabase'

async function deletePost(postId) {
  try {
    await deleteBlogPost(postId)
    
    console.log('Post deleted successfully')
  } catch (error) {
    console.error('Error deleting post:', error)
    throw error
  }
}
```

**Note:** Deleting a post from Firestore does not automatically delete images from Cloudinary. You'll need to manually delete images from your Cloudinary dashboard or implement server-side deletion.

---

## Image Upload

### Example 1: Upload with Progress Tracking

```javascript
import { uploadImageToCloudinary } from '../lib/cloudinary'

async function uploadWithProgress(imageFile) {
  try {
    const result = await uploadImageToCloudinary(
      imageFile,
      'blog-images',
      (progress) => {
        // Update UI with progress
        console.log(`Upload progress: ${progress.toFixed(1)}%`)
        updateProgressBar(progress)
      }
    )
    
    console.log('Upload complete!')
    console.log('URL:', result.url)
    console.log('Public ID:', result.publicId)
    console.log('Dimensions:', `${result.width}x${result.height}`)
    
    return result
  } catch (error) {
    console.error('Upload failed:', error)
    throw error
  }
}
```

### Example 2: Upload Multiple Images

```javascript
import { uploadImageToCloudinary } from '../lib/cloudinary'

async function uploadMultipleImages(imageFiles) {
  try {
    const uploadPromises = imageFiles.map(file => 
      uploadImageToCloudinary(file, 'blog-images')
    )
    
    const results = await Promise.all(uploadPromises)
    
    console.log(`Uploaded ${results.length} images`)
    results.forEach((result, index) => {
      console.log(`Image ${index + 1}: ${result.url}`)
    })
    
    return results
  } catch (error) {
    console.error('Error uploading images:', error)
    throw error
  }
}
```

### Example 3: Upload with Validation

```javascript
import { uploadImageToCloudinary } from '../lib/cloudinary'

async function uploadWithValidation(imageFile) {
  // Validate file type
  if (!imageFile.type.startsWith('image/')) {
    throw new Error('Please select an image file')
  }
  
  // Validate file size (max 5MB)
  const maxSize = 5 * 1024 * 1024 // 5MB
  if (imageFile.size > maxSize) {
    throw new Error('Image size must be less than 5MB')
  }
  
  try {
    const result = await uploadImageToCloudinary(imageFile, 'blog-images')
    console.log('Upload successful:', result.url)
    return result
  } catch (error) {
    console.error('Upload failed:', error)
    throw error
  }
}
```

---

## Complete Example: Full Blog Post Workflow

```javascript
import { createBlogPost, updateBlogPost, getBlogPostById } from '../lib/blogDatabase'
import { uploadImageToCloudinary } from '../lib/cloudinary'

class BlogPostManager {
  /**
   * Create a new blog post with image
   */
  async create(formData, imageFile) {
    try {
      // Upload image if provided
      let imageUrl = ''
      if (imageFile) {
        const result = await uploadImageToCloudinary(
          imageFile,
          'blog-images',
          (progress) => this.onProgress(progress)
        )
        imageUrl = result.url
      }
      
      // Create blog post
      const postData = {
        title: formData.title,
        content: formData.content,
        excerpt: formData.excerpt,
        coverImage: imageUrl,
        imageUrl: imageUrl,
        tags: formData.tags.split(',').map(t => t.trim()),
        categories: formData.categories.split(',').map(c => c.trim()),
        metaTitle: formData.metaTitle || formData.title,
        metaDescription: formData.metaDescription || formData.excerpt,
        keyword: formData.keyword,
        canonicalUrl: formData.canonicalUrl,
        published: formData.published,
        publishDate: formData.published ? new Date().toISOString() : null
      }
      
      const postId = await createBlogPost(postData)
      console.log('✅ Post created:', postId)
      
      return postId
    } catch (error) {
      console.error('❌ Error creating post:', error)
      throw error
    }
  }
  
  /**
   * Update existing blog post
   */
  async update(postId, formData, newImageFile) {
    try {
      const updateData = {
        title: formData.title,
        content: formData.content,
        excerpt: formData.excerpt,
        tags: formData.tags.split(',').map(t => t.trim()),
        categories: formData.categories.split(',').map(c => c.trim()),
        metaTitle: formData.metaTitle,
        metaDescription: formData.metaDescription,
        keyword: formData.keyword,
        canonicalUrl: formData.canonicalUrl,
        published: formData.published
      }
      
      // Upload new image if provided
      if (newImageFile) {
        const result = await uploadImageToCloudinary(
          newImageFile,
          'blog-images',
          (progress) => this.onProgress(progress)
        )
        updateData.coverImage = result.url
        updateData.imageUrl = result.url
      }
      
      await updateBlogPost(postId, updateData)
      console.log('✅ Post updated:', postId)
      
      return postId
    } catch (error) {
      console.error('❌ Error updating post:', error)
      throw error
    }
  }
  
  /**
   * Get post for editing
   */
  async getForEdit(postId) {
    try {
      const post = await getBlogPostById(postId)
      
      if (!post) {
        throw new Error('Post not found')
      }
      
      return {
        ...post,
        tags: post.tags.join(', '),
        categories: post.categories.join(', ')
      }
    } catch (error) {
      console.error('❌ Error fetching post:', error)
      throw error
    }
  }
  
  onProgress(progress) {
    console.log(`Upload progress: ${progress.toFixed(1)}%`)
  }
}

// Usage
const manager = new BlogPostManager()

// Create post
const postId = await manager.create(formData, imageFile)

// Update post
await manager.update(postId, updatedFormData, newImageFile)

// Get post for editing
const post = await manager.getForEdit(postId)
```

---

## Error Handling

### Best Practices

```javascript
import { createBlogPost } from '../lib/blogDatabase'
import { uploadImageToCloudinary } from '../lib/cloudinary'

async function createPostWithErrorHandling(formData, imageFile) {
  try {
    // Validate required fields
    if (!formData.title || !formData.content) {
      throw new Error('Title and content are required')
    }
    
    let imageUrl = ''
    
    // Upload image with error handling
    if (imageFile) {
      try {
        const result = await uploadImageToCloudinary(imageFile, 'blog-images')
        imageUrl = result.url
      } catch (uploadError) {
        console.error('Image upload failed:', uploadError)
        
        // Decide how to handle upload failure
        if (uploadError.message.includes('Cloudinary is not configured')) {
          throw new Error('Image upload service is not configured. Please contact support.')
        } else if (uploadError.message.includes('timeout')) {
          throw new Error('Image upload timeout. Please try a smaller image.')
        } else {
          throw new Error('Image upload failed. Please try again.')
        }
      }
    }
    
    // Create post
    const postData = {
      ...formData,
      coverImage: imageUrl,
      imageUrl: imageUrl,
      publishDate: new Date().toISOString()
    }
    
    const postId = await createBlogPost(postData)
    
    return {
      success: true,
      postId: postId,
      message: 'Blog post created successfully'
    }
    
  } catch (error) {
    console.error('Error in createPostWithErrorHandling:', error)
    
    return {
      success: false,
      error: error.message || 'Unknown error occurred',
      details: error
    }
  }
}
```

---

## Summary

- **Firestore** stores blog post data (text, metadata, SEO)
- **Cloudinary** stores images (only URLs saved to Firestore)
- All functions are promise-based (use `async/await`)
- Images are automatically compressed before upload
- Full CRUD operations available
- Schema markup support for SEO
- Draft and publish workflow
